# Move the Set-ShellCommand function outside of Import-Aliases
function Set-ShellCommand {
    param (
        [string]$Name,
        [string]$Command
    )

    try {
        # Set-Alias only supports a single command name.
        # For multi-token commands, create a function that runs the stored command and
        # appends any extra arguments the user passes.
        if ($Command -match '\s') {
            $escapedCommand = $Command -replace "'", "''"

            $functionBody = @"
param(
    [Parameter(ValueFromRemainingArguments=`$true)]
    [string[]]`$Args
)

`$cmd = '$escapedCommand'
if (`$Args.Count -gt 0) {
    try {
        `$quotedArgs = `$Args | ForEach-Object { [System.Management.Automation.Language.CodeGeneration]::QuoteArgument(`$_) }
        `$cmd = `$cmd + ' ' + (`$quotedArgs -join ' ')
    } catch {
        `$cmd = `$cmd + ' ' + (`$Args -join ' ')
    }
}

Invoke-Expression `$cmd
"@

            Set-Item -Path "Function:$Name" -Value ([scriptblock]::Create($functionBody)) -Force -ErrorAction Stop
        }
        else {
            Set-Alias -Name $Name -Value $Command -Scope Global -Force -ErrorAction Stop
        }
    }
    catch {
        Write-Warning "Failed to set command '$Name': $_"
    }
}

# Function to load aliases from Chezmoi data
function Import-Aliases {
    try {
        # Load common aliases
        {{ range $key, $value := .aliases.common }}
        Set-ShellCommand -Name "{{ $key }}" -Command "{{ $value }}"
        {{ end }}

        # Load environment-specific aliases
        {{ if .personal_computer }}
        {{ range $key, $value := .aliases.personal_computer }}
        Set-ShellCommand -Name "{{ $key }}" -Command "{{ $value }}"
        {{ end }}
        {{ end }}

        {{ if .work_computer }}
        {{ range $key, $value := .aliases.work_computer }}
        Set-ShellCommand -Name "{{ $key }}" -Command "{{ $value }}"
        {{ end }}
        {{ end }}

        {{ if .dev_computer }}
        {{ range $key, $value := .aliases.dev_computer }}
        Set-ShellCommand -Name "{{ $key }}" -Command "{{ $value }}"
        {{ end }}
        {{ end }}

        {{ if .docker_computer }}
        {{ range $key, $value := .aliases.docker_computer }}
        Set-ShellCommand -Name "{{ $key }}" -Command "{{ $value }}"
        {{ end }}
        {{ end }}

    }
    catch {
        Write-Error "Failed to load aliases: $_"
    }
}

# Load aliases immediately
Import-Aliases